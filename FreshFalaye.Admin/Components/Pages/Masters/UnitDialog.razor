@rendermode InteractiveServer
@using FreshFalaye.Admin.Models
@using FreshFalaye.Admin.Services
@inject UnitApiService UnitApi
@inject DialogService DialogService
@inherits BasePage
@inject UnitApiService UnitApi
@inject DialogService DialogService
@inject IJSRuntime JS
@inject AdminAuthService Auth


<RadzenCard Style="padding:10px">

    <div class="row g-2">

        <div class="col-4">
            <RadzenLabel Text="Code" />
            <RadzenTextBox @bind-Value="model.UnitCode"
                           Style="width:100%"
                           @ref="codeBox" />
        </div>

        <div class="col-8">
            <RadzenLabel Text="Unit Name" />
            <RadzenTextBox @bind-Value="model.UnitName"
                           Style="width:100%" />
        </div>

        @* <div class="col-12">
            <RadzenCheckBox @bind-Value="model.DecimalAllowed" />
            <RadzenLabel Text="Allow Decimal (Kg, Ltr)" />
        </div> *@

    </div>
    <div class="mt-3 d-flex">

        <!-- LEFT: DELETE (only in edit mode) -->
        @if (UnitId != null)
        {
            <RadzenButton Text="Delete (Del)"
                          Icon="delete"
                          ButtonStyle="ButtonStyle.Danger"
                          ButtonType="ButtonType.Button"
                          Size="ButtonSize.Small"
                          Click="@DeleteClick" />
        }

        <!-- RIGHT: SAVE / CANCEL -->
        <div class="ms-auto">
            <RadzenButton Text="Save (Alt+S)"
                          ButtonType="ButtonType.Button"
                          Size="ButtonSize.Small"
                          Click="@SaveClick" />

            <RadzenButton Text="Cancel (Esc)"
                          ButtonType="ButtonType.Button"
                          Size="ButtonSize.Small"
                          Click="@Close"
                          Style="margin-left:5px" />
        </div>
    </div>


</RadzenCard>


@code {

    [Parameter] public int? UnitId { get; set; }

    UnitDto model = new();
    RadzenTextBox codeBox;
    DotNetObjectReference<UnitDialog>? objRef;
    bool dataLoaded;

    protected override async Task OnInitializedAsync()
    {
        Auth.OnChange += HandleAuthChanged;
    }

    void HandleAuthChanged()
    {
        _ = InvokeAsync(async () =>
        {
            if (!dataLoaded &&
                Auth.IsInitialized &&
                Auth.CurrentUser != null)
            {
                await LoadDataAsync();
            }
        });
    }
    public void Dispose()
    {
        Auth.OnChange -= HandleAuthChanged;
        objRef?.Dispose();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {            
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("registerDialogShortcuts", objRef);

            if (!dataLoaded &&
                Auth.IsInitialized &&
                Auth.CurrentUser != null)
            {
                await LoadDataAsync();
            }


            await codeBox.FocusAsync();
        }        
    }

    async Task LoadDataAsync()
    {
        dataLoaded = true;
        if (UnitId.HasValue)
            model = await UnitApi.GetUnitAsync(UnitId.Value);
        await InvokeAsync(StateHasChanged);

    }
    [JSInvokable]
    public async Task OnAltS()
    {
        await SaveClick();
    }

    [JSInvokable]
    public Task OnEsc()
    {
        Close();
        return Task.CompletedTask;
    }

    async Task SaveClick()
    {
        try
        {
            model.UnitCode = model.UnitCode.Trim().ToUpper();
            model.UnitName = model.UnitName.Trim();

            if (string.IsNullOrWhiteSpace(model.UnitCode))
            {
                ShowError("Please enter Unit Code");
                return;
            }
            else if (string.IsNullOrWhiteSpace(model.UnitName))
            {
                ShowError("Please enter Unit Name");
                return;
            }
            HttpResponseMessage response;
            if (UnitId == null)
            {
                response = await UnitApi.CreateUnitAsync(model);
                await HandleApiResponse(response);
                StateHasChanged();
            }
            else
            {
                response = await UnitApi.UpdateUnitAsync(model.UnitId, model);
                await HandleApiResponse(response);
                StateHasChanged();
            }
            DialogService.Close();
        }
        catch (ApiException ex)
        {
            ShowError(ex.Message);
        }
        catch (Exception)
        {
            ShowError("Unexpected system error");
        }
        
    }

    async Task DeleteClick()
    {
        bool? confirm = await DialogService.Confirm(
            $"Delete unit '{model.UnitName}'?",
            "Confirm Delete",
            new ConfirmOptions
            {
                OkButtonText = "Yes",
                CancelButtonText = "No"
            });

        if (confirm == true)
        {
            var response = await UnitApi.DeleteUnitAsync(model.UnitId);
            await HandleApiResponse(response);
            StateHasChanged();
            DialogService.Close();
        }
    }
  
    void ShowSuccess(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Success",
            Detail = message,
            Duration = 2000
        });
    }
    void ShowError(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = "Error",
            Detail = message,
            Duration = 4000
        });
    }

    void Close() => DialogService.Close();
}

