@rendermode InteractiveServer
@using FreshFalaye.Admin.Models
@using FreshFalaye.Admin.Services
@inherits BasePage
@inject AccountApiService AccountApi
@inject AccountGroupApiService AccountGroupApi
@inject DialogService DialogService
@inject IJSRuntime JS
@inject AdminAuthService Auth


@implements IDisposable

<RadzenCard Style="padding:10px">

    <div class="row g-2">

        <div class="col-2">
            <RadzenLabel Text="Account Code" />
            <RadzenTextBox @bind-Value="model.AccountCode"
                           Style="width:100%"
                           @ref="codeBox" />
        </div>
        <div class="col-2 d-flex align-items-end">
            <RadzenDropDown Data="@groups"
                            TextProperty="GroupName"
                            ValueProperty="Id"
                            @bind-Value="model.AccountGroupId"
                            Style="width:100%" />
        </div>

        <div class="col-8">
            <RadzenLabel Text="Account Name" />
            <RadzenTextBox @bind-Value="model.AccountName"
                           Style="width:100%" />
        </div>
       

        <div class="col-12">
            <RadzenLabel Text="Address" />
            <RadzenTextArea @bind-Value="model.Address"
                            Style="width:100%" Rows="2" />
            
        </div>

        <div class="col-6">
            <RadzenLabel Text="Contact No." />
            <RadzenTextBox @bind-Value="model.ContactNumber"
                           Style="width:100%" />
        </div>

        <div class="col-6">
            <RadzenLabel Text="Mobile No." />
            <RadzenTextBox @bind-Value="model.MobileNo"
                           Style="width:100%" />
        </div>

        <div class="col-6">
            <RadzenLabel Text="Email" />
            <RadzenTextBox @bind-Value="model.Email"
                           Style="width:100%" />
        </div>

        <div class="col-6">
            <RadzenLabel Text="GST No." />
            <RadzenTextBox @bind-Value="model.GstNo"
                           Style="width:100%" />
        </div>

        <div class="col-6">
            <RadzenLabel Text="Opening Balance" />
            <RadzenNumeric @bind-Value="model.OpeningBalance"
                           Style="width:100%"
                           Format="0.00" />
        </div>

        <div class="col-6 d-flex align-items-end">
            <RadzenRadioButtonList @bind-Value="model.IsCredit"
                                   Data="@creditDebit"
                                   TextProperty="Text"
                                   ValueProperty="Value" />
        </div>

        <div class="col-12">
            <RadzenCheckBox @bind-Value="model.IsApMc" />
            <RadzenLabel Text="APMC Party" />
        </div>

    </div>

    <div class="mt-3 d-flex">

        @if (AccountId != null)
        {
            <RadzenButton Text="Delete (Del)"
                          Icon="delete"
                          ButtonStyle="ButtonStyle.Danger"
                          ButtonType="ButtonType.Button"
                          Size="ButtonSize.Small"
                          Click="@DeleteClick" />
        }

        <div class="ms-auto">
            <RadzenButton Text="Save (Alt+S)"
                          ButtonType="ButtonType.Button"
                          Size="ButtonSize.Small"
                          Click="@SaveClick" />

            <RadzenButton Text="Cancel (Esc)"
                          ButtonType="ButtonType.Button"
                          Size="ButtonSize.Small"
                          Click="@Close"
                          Style="margin-left:5px" />
        </div>
    </div>

</RadzenCard>

@code {

    [Parameter] public Guid? AccountId { get; set; }

    AccountDto model = new();
    RadzenTextBox codeBox;

    List<AccountGroupDto> groups = new();
    DotNetObjectReference<AccountDialog>? objRef;
    bool dataLoaded;

    List<object> creditDebit = new()
    {
        new { Text = "Credit", Value = true },
        new { Text = "Debit", Value = false }
    };

   
    protected override async Task OnInitializedAsync()
    {
        Auth.OnChange += HandleAuthChanged;
    }

    void HandleAuthChanged()
    {
        _ = InvokeAsync(async () =>
        {
            if (!dataLoaded &&
                Auth.IsInitialized &&
                Auth.CurrentUser != null)
            {
                await LoadDataAsync();
            }
        });
    }

    async Task LoadDataAsync()
    {
        dataLoaded = true;
        groups = await AccountGroupApi.GetAccountGroupsAsync();
        if (AccountId.HasValue)
        {
            model = (await AccountApi.GetAccountsAsync())
                .First(p => p.Id == AccountId.Value);
        }        
        await InvokeAsync(StateHasChanged);
    }
    public void Dispose()
    {
        Auth.OnChange -= HandleAuthChanged;
        objRef?.Dispose();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("registerDialogShortcuts", objRef);

            if (!dataLoaded &&
                Auth.IsInitialized &&
                Auth.CurrentUser != null)
            {
                await LoadDataAsync();
            }

            await codeBox.FocusAsync();
        }
    }

    [JSInvokable]
    public async Task OnAltS()
    {  
        await SaveClick();     
    }


    [JSInvokable]
    public Task OnEsc()
    {
        Close();
        return Task.CompletedTask;
    }

    async Task SaveClick()
    {
        try
        {


            if (string.IsNullOrWhiteSpace(model.AccountCode))
            {
                ShowError("Please enter Account Code");
                return;
            }
            else if (string.IsNullOrWhiteSpace(model.AccountName))
            {
                ShowError("Please enter Account Name");
                return;
            }
            model.AccountCode = model.AccountCode?.Trim().ToUpper();
            model.AccountName = model.AccountName?.Trim();

            HttpResponseMessage response;

            if (AccountId == null)
            {
                response = await AccountApi.CreateAsync(model);
                await HandleApiResponse(response);
                StateHasChanged();
            }
            else
            {
                response = await AccountApi.UpdateAsync(model.Id, model);
                await HandleApiResponse(response);
                StateHasChanged();
            }
            
            DialogService.Close();
        }
        catch (ApiException ex)
        {
            ShowError(ex.Message);
        }
        catch (Exception)
        {
            ShowError("Unexpected system error");
        }
        
    }

    async Task DeleteClick()
    {
        bool? confirm = await DialogService.Confirm(
            $"Delete account '{model.AccountName}'?",
            "Confirm Delete");

        if (confirm == true)
        {
            var response = await AccountApi.DeleteAsync(model.Id);
            await HandleApiResponse(response);
            StateHasChanged();
            DialogService.Close();
        }
    }

    void ShowSuccess(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Success",
            Detail = message,
            Duration = 2000
        });
    }
    void ShowError(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = "Error",
            Detail = message,
            Duration = 4000
        });
    }

    void Close() => DialogService.Close();
}
